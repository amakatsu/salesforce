<template>
  <!-- ★ 背景を白にしたアコーディオン全体 -->
  <lightning-accordion
    allow-multiple-sections-open
    class="slds-box slds-theme_default"
  >
    <!-- 操作ボタン群 -->
    <div class="slds-var-p-around_small">
      <lightning-layout multiple-rows class="slds-wrap">
        <!-- 左側：再取得～登録 -->
        <lightning-layout-item size="4" padding="horizontal-small">
          <lightning-button
            label="計数再取得"
            onclick={handleFetchCalculation}
          ></lightning-button>
          <lightning-button
            label="計算"
            onclick={handleCalculate}
          ></lightning-button>
          <lightning-button
            label="補正値登録"
            onclick={handleRegisterCorrection}
          ></lightning-button>
          <lightning-button
            label="登録"
            onclick={handleRegister}
          ></lightning-button>
        </lightning-layout-item>

        <!-- 右側：各種照会／明細 -->
        <lightning-layout-item
          size="8"
          class="slds-text-align_right"
          padding="horizontal-small"
        >
          <lightning-button
            label="ファイル出力"
            onclick={handleFileExport}
          ></lightning-button>
          <lightning-button
            label="Excel出力"
            onclick={handleExcelExport}
          ></lightning-button>
          <lightning-button
            label="直近計数照会"
            onclick={handleRecentInquiry}
          ></lightning-button>
          <lightning-button
            label="過去審査"
            onclick={handlePastReview}
          ></lightning-button>
          <lightning-button
            label="預金担保明細"
            onclick={handleDepositDetail}
          ></lightning-button>
          <lightning-button
            label="手形電債残高"
            onclick={handleBillBalance}
          ></lightning-button>
          <lightning-button
            label="有価証券明細"
            onclick={handleSecuritiesDetail}
          ></lightning-button>
          <lightning-button
            label="協会保証明細"
            onclick={handleAssociationGuarantee}
          ></lightning-button>
          <lightning-button
            label="不動産担保明細"
            onclick={handleRealEstateDetail}
          ></lightning-button>
        </lightning-layout-item>
      </lightning-layout>
    </div>

    <!-- 取引先情報 -->
    <lightning-accordion-section
      name="accountInfo"
      label="取引先情報"
      icon-name="standard:choice"
    >
      <lightning-layout
        multiple-rows
        class="slds-var-p-around_x-small"
        horizontal-align="spread"
      >
        <lightning-layout-item
          size="4"
          class="slds-truncate"
          title={branchNumber}
        >
          <span
            class="slds-form-element__label slds-text-title_caps slds-text-title_bold"
            >店番</span
          >
          <lightning-formatted-text
            value={branchNumber}
          ></lightning-formatted-text>
        </lightning-layout-item>

        <lightning-layout-item
          size="4"
          class="slds-text-align_center slds-truncate"
          title={branchName}
        >
          <span
            class="slds-form-element__label slds-text-title_caps slds-text-title_bold"
            >店名</span
          >
          <lightning-formatted-text
            value={branchName}
          ></lightning-formatted-text>
        </lightning-layout-item>

        <lightning-layout-item
          size="4"
          class="slds-text-align_right slds-truncate"
          title={customerName}
        >
          <span
            class="slds-form-element__label slds-text-title_caps slds-text-title_bold"
            >取引先名</span
          >
          <lightning-formatted-text
            value={customerName}
          ></lightning-formatted-text>
        </lightning-layout-item>
      </lightning-layout>
    </lightning-accordion-section>

    <!-- 審査番号・金額単位・括り -->
    <lightning-accordion-section
      name="reviewDetails"
      label="審査番号・金額単位・括り"
      icon-name="standard:choice"
    >
      <lightning-layout
        multiple-rows
        class="slds-var-p-around_x-small"
        horizontal-align="spread"
      >
        <lightning-layout-item size="4">
          <span
            class="slds-form-element__label slds-text-title_caps slds-text-title_bold"
            >審査番号</span
          >
          <lightning-formatted-text
            value={reviewNumber}
          ></lightning-formatted-text>
        </lightning-layout-item>
        <lightning-layout-item size="4" class="slds-text-align_center">
          <span
            class="slds-form-element__label slds-text-title_caps slds-text-title_bold"
            >金額単位</span
          >
          <lightning-formatted-text
            value={amountUnit}
          ></lightning-formatted-text>
        </lightning-layout-item>
        <lightning-layout-item size="4" class="slds-text-align_right">
          <span
            class="slds-form-element__label slds-text-title_caps slds-text-title_bold"
            >括り</span
          >
          <lightning-formatted-text
            value={groupNumber}
          ></lightning-formatted-text>
        </lightning-layout-item>
      </lightning-layout>
    </lightning-accordion-section>

    <!-- 補正理由等 -->
    <lightning-accordion-section
      name="correctionReasons"
      label="補正理由等"
      icon-name="standard:choice"
    >
      <!-- ★ gutters で列間余白、horizontal-align="spread" はそのまま -->
      <lightning-layout
        class="slds-var-p-around_x-small slds-gutters_x-large"
        multiple-rows
        horizontal-align="spread"
      >
        <!-- 補正理由 (左 6 / 12) -->
        <lightning-layout-item
          size="6"
          flexibility="auto"
          padding="around-small"
        >
          <lightning-layout vertical-align="center">
            <lightning-layout-item size="1" class="slds-align-middle">
              <span class="slds-form-element__label slds-text-title_bold">
                補正理由
              </span>
            </lightning-layout-item>
            <lightning-layout-item size="11">
              <div
                class="slds-box slds-theme_default"
                style="
                  height: 100px;
                  overflow-y: auto;
                  white-space: normal;
                  word-break: break-word;
                "
              >
                <lightning-formatted-text
                  value={correctionReason}
                  class="slds-text-body_regular"
                  style="font-size: 0.875rem"
                ></lightning-formatted-text>
              </div>
            </lightning-layout-item>
          </lightning-layout>
        </lightning-layout-item>

        <!-- 補正値関連項目 (右 6 / 12) -->
        <lightning-layout-item
          size="6"
          flexibility="auto"
          padding="around-small"
        >
          <lightning-layout multiple-rows class="slds-gutters_small">
            <!-- 6 枚のミニ項目を 2 列配置 -->
            <lightning-layout-item size="6" padding="vertical-xxx-small">
              <span class="slds-form-element__label slds-text-title_bold">
                プール区分
              </span>
              <lightning-formatted-text
                value={poolCategory}
              ></lightning-formatted-text>
            </lightning-layout-item>
            <lightning-layout-item size="6" padding="vertical-xxx-small">
              <span class="slds-form-element__label slds-text-title_bold">
                金額単位
              </span>
              <lightning-formatted-text
                value={amountUnit}
              ></lightning-formatted-text>
            </lightning-layout-item>
            <lightning-layout-item size="6" padding="vertical-xxx-small">
              <span class="slds-form-element__label slds-text-title_bold">
                限度一般
              </span>
              <lightning-formatted-text
                value={limitGeneral}
              ></lightning-formatted-text>
            </lightning-layout-item>
            <lightning-layout-item size="6" padding="vertical-xxx-small">
              <span class="slds-form-element__label slds-text-title_bold">
                算入市場性
              </span>
              <lightning-formatted-text
                value={marketInclusion}
              ></lightning-formatted-text>
            </lightning-layout-item>
            <lightning-layout-item size="6" padding="vertical-xxx-small">
              <span class="slds-form-element__label slds-text-title_bold">
                規定担保
              </span>
              <lightning-formatted-text
                value={regulatoryCollateral}
              ></lightning-formatted-text>
            </lightning-layout-item>
            <lightning-layout-item size="6" padding="vertical-xxx-small">
              <span class="slds-form-element__label slds-text-title_bold">
                保全率
              </span>
              <lightning-formatted-text
                value={protectionRate}
              ></lightning-formatted-text>
            </lightning-layout-item>
          </lightning-layout>
        </lightning-layout-item>
      </lightning-layout>
    </lightning-accordion-section>

    <!-- 一般与信 -->
    <lightning-accordion-section
      name="creditOverview"
      label="一般与信"
      icon-name="standard:choice"
    >
      <lightning-tabset variant="scoped">
        <!-- 一般与信1 -->
        <lightning-tab label="一般与信1">
          <!-- ★ 全体高さ固定 -->
          <lightning-layout style="height: 450px; column-gap: 7px">
            <!-- 与信状況（左）-->
            <lightning-layout-item
              size="8"
              style="
                min-width: 0;
                min-height: 0;
                display: flex;
                flex-direction: column;
              "
            >
              <!-- 見出しは固定 -->
              <h3 class="slds-text-title_bold">与信状況</h3>

              <!-- ツリーだけスクロールさせる -->
              <div class="slds-scrollable_y" style="flex: 1 1 0; min-height: 0">
                <lightning-tree-grid
                  key-field="id"
                  data={treeGridData1}
                  columns={treeGridColumns1}
                  hide-checkbox-column
                  onrowaction={handleRowAction}
                ></lightning-tree-grid>
              </div>
            </lightning-layout-item>

            <!-- 本件保全状況＋保証人（右）-->
            <lightning-layout-item
              size="4"
              style="
                min-width: 0;
                min-height: 0;
                display: flex;
                flex-direction: column;
              "
            >
              <!-- 見出しは固定 -->
              <h3 class="slds-text-title_bold">本件保全状況</h3>

              <!-- 保全ツリー -->
              <div
                class="slds-scrollable_y"
                style="flex: 1 1 0; min-height: 0; margin-bottom: 0.5rem"
              >
                <lightning-tree-grid
                  key-field="id"
                  data={treeGridData2}
                  columns={treeGridColumns2}
                  hide-checkbox-column
                ></lightning-tree-grid>
              </div>

              <!-- 保証人テーブル -->
              <div class="slds-scrollable_y" style="flex: 1 1 0; min-height: 0">
                <lightning-datatable
                  key-field="id"
                  data={guarantorData}
                  columns={guarantorColumns}
                  hide-checkbox-column
                ></lightning-datatable>
              </div>
            </lightning-layout-item>
          </lightning-layout>
        </lightning-tab>

        <lightning-tab label="一般与信2">
          <div class="slds-p-around_small">一般与信2（仮表示）</div>
        </lightning-tab>
        <lightning-tab label="市場性与信1">
          <div class="slds-p-around_small">市場性与信1（仮表示）</div>
        </lightning-tab>
        <lightning-tab label="市場性与信2">
          <div class="slds-p-around_small">市場性与信2（仮表示）</div>
        </lightning-tab>
      </lightning-tabset>
    </lightning-accordion-section>
  </lightning-accordion>

  <!-- ★ 補正値編集モーダル -->
  <template if:true={isModalOpen}>
    <section role="dialog" class="slds-modal slds-fade-in-open">
      <div class="slds-modal__container">
        <header class="slds-modal__header">
          <h2 class="slds-text-heading_medium">補正値を編集</h2>
        </header>
        <div class="slds-modal__content slds-p-around_medium">
          <lightning-input
            type="number"
            label="補正値"
            value={editRow.correction}
            onchange={handleCorrectionInput}
          ></lightning-input>
        </div>
        <footer class="slds-modal__footer">
          <lightning-button
            variant="neutral"
            label="キャンセル"
            onclick={closeModal}
          ></lightning-button>
          <lightning-button
            variant="brand"
            label="保存"
            onclick={saveCorrection}
          ></lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>
</template>
